<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>User</title>
    {% include "admin/admin_css_link.html" %}
</head>

<body>
{% include "admin/admin_header.html" %}
<div id="app" class="container-fluid page-body-wrapper">
    {% include "admin/sidebar_admin.html" %}

    <div class="row flex-grow">
        <div class="col-12 grid-margin stretch-card">
            <div class="card card-rounded">
                <div class="card-body">
                    <div class="d-sm-flex justify-content-between align-items-start">
                        <div>
                            <h4 class="card-title card-title-dash" style="font-family: 'Bahnschrift SemiBold',serif">
                                Current User</h4>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-primary" @click="openModal">Add New User</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Gender</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Password</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% raw %}
                            <tr v-for="(item, index) in user_list" :key="'list_'+index">
                                <td>
                                    <img :src="'/static/images/cropped/' + item.image" alt="User Image"
                                         class="img-thumbnail" style="width: 50px; height: 50px;"
                                         @click="showImageModal(item.image)">
                                </td>

                                <td>{{ item.name }}</td>
                                <td>{{ item.gender }}</td>
                                <td>{{ item.phone }}</td>
                                <td>{{ item.email }}</td>
                                <td>{{ item.password }}</td>
                                <td>
                                    <button class="btn btn-warning m-1" @click="editUser(item)">Edit</button>
                                    <button class="btn btn-danger" @click="deleteUser(item, index)">Delete</button>
                                </td>
                            </tr>
                            {% endraw %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    {% raw %}
                    <h5 class="modal-title" id="addUserModalLabel">{{ isEdit ? 'Edit User' : 'Add new User' }}</h5>
                    {% endraw %}
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="submitForm">
                        <div class="mb-3">
                            <label for="image" class="form-label">Choose Image</label>
                            <input type="file" class="form-control" id="image" @change="onImageChange">
                        </div>
                        <div v-if="imagePreview">
                            <img id="imagePreview" :src="imagePreview" class="img-fluid mt-2"/>
                        </div>

                        <div v-if="!imagePreview && form.image" class="mt-3">
                            <img :src="'/static/images/cropped/' + form.image" alt="Current Image"
                                 class="img-fluid mt-2" style="max-height: 200px; object-fit: cover;"/>
                        </div>

                        <div v-if="imagePreview" class="mt-3">
                            <button type="button" class="btn btn-success" @click="cropImage">Crop Image</button>
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" v-model="form.name"
                                   placeholder="Enter customer name" required>
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" v-model="form.password"
                                   required>
                        </div>

                        <div class="mb-3">
                            <label for="gender" class="form-label">Gender</label>
                            <select class="form-control" id="gender" v-model="form.gender" required>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone" v-model="form.phone" placeholder="+855"
                                   required>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" v-model="form.email"
                                   placeholder="example@mail.com" required>
                        </div>

                        {% raw %}

                        <button type="submit" class="btn btn-primary">{{ isEdit ? 'Update' : 'Save' }}</button>
                        {% endraw %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <img :src="modalImageSrc" alt="Full Image" class="img-fluid">
                </div>
            </div>
        </div>
    </div>

</div>


<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const {createApp} = Vue;

    const app = createApp({
        data() {
            return {
                isEdit: false,
                form: {
                    name: '',
                    gender: 'Male',
                    phone: '+855',
                    email: '',
                    password: '',
                    croppedImage: null
                },
                user_list: [],
                imageFile: null,
                imagePreview: null,
                cropper: null,
                croppedImageBlob: '',
                modalImageSrc: ''
            }
        },
        methods: {
            fetchUsers() {
                fetch('/get_users')
                    .then(response => response.json())
                    .then(data => {
                        this.user_list = data;
                    })
                    .catch(error => console.error('Error fetching users:', error));
            },

            showImageModal(image) {
                this.modalImageSrc = '/static/images/compressed/' + image;
                const modal = new bootstrap.Modal(document.getElementById('imageModal'));
                modal.show();
            },


            openModal() {
                this.isEdit = false;
                this.resetForm();
                const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
                modal.show();
            },

            onImageChange(event) {
                const file = event.target.files[0];
                if (file) {
                    this.imageFile = file;
                    this.imagePreview = URL.createObjectURL(file);

                    this.$nextTick(() => {
                        const imageElement = document.getElementById('imagePreview');
                        this.cropper = new Cropper(imageElement, {
                            aspectRatio: 1,
                            viewMode: 1
                        });
                    });
                }
            },

            cropImage() {
                if (this.cropper) {
                    this.cropper.getCroppedCanvas().toBlob((blob) => {
                        if (blob) {

                            const originalName = this.imageFile?.name || 'default_image.jpg';
                            const fileExtension = originalName.split('.').pop();
                            const fileName = `${originalName.replace(/\.[^/.]+$/, '')}.${fileExtension}`;

                            const file = new File([blob], fileName, {type: blob.type});

                            this.form.croppedImage = file;

                            this.imagePreview = URL.createObjectURL(blob);

                            this.cropper.destroy();
                            this.cropper = null;
                        }
                    }, 'image/jpeg');
                }
            },
            editUser(user) {
                this.isEdit = true;
                this.form = {...user};
                const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
                modal.show();
            },

            submitForm() {
                const formData = new FormData();
                formData.append('name', this.form.name);
                formData.append('gender', this.form.gender);
                formData.append('phone', this.form.phone);
                formData.append('email', this.form.email);
                formData.append('password', this.form.password);

                if (this.form.croppedImage) {
                    formData.append('image', this.form.croppedImage);
                } else if (this.imageFile) {
                    // Send the file if no cropped image
                    formData.append('image', this.imageFile);
                }

                if (this.imageFile) {
                    formData.append('original', this.imageFile);
                }

                const url = this.isEdit ? `/update_user/${this.form.id}` : '/add_user';
                const method = this.isEdit ? 'PUT' : 'POST';


                console.log([...formData.entries()]);

                fetch(url, {
                    method: method,
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.message) {
                            Swal.fire({
                                position: "top-end",
                                icon: "success",
                                title: this.isEdit ? "User updated successfully!" : "User saved successfully!",
                                showConfirmButton: false,
                                timer: 1500
                            });


                            if (this.isEdit) {
                                const index = this.user_list.findIndex(user => user.id === this.form.id);
                                if (index !== -1) {
                                    this.user_list[index].image = data.image;
                                    this.user_list[index].name = this.form.name;
                                    this.user_list[index].gender = this.form.gender;
                                    this.user_list[index].phone = this.form.phone;
                                    this.user_list[index].email = this.form.email;
                                    this.user_list[index].password = this.form.password;
                                }
                            }

                            this.fetchUsers();
                            this.resetForm(); //
                            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
                            modal.hide();
                        } else {
                            Swal.fire({
                                icon: "error",
                                title: "Oops...",
                                text: data.error || "Something went wrong!"
                            });
                            console.error(data.error);
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        Swal.fire({
                            icon: "error",
                            title: "Error",
                            text: error.message || "Something went wrong!"
                        });
                    });
            },

            deleteUser(user, index) {
                Swal.fire({
                    title: "Are you sure?",
                    text: "You won't be able to revert this!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Yes, delete it!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/delete_user/${user.id}`, {
                            method: 'DELETE'
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.message === 'User deleted successfully') {
                                    this.user_list.splice(index, 1);
                                    Swal.fire({
                                        title: "Deleted!",
                                        text: "The user has been deleted.",
                                        icon: "success"
                                    });
                                } else {
                                    console.error(data.error);
                                }
                            })
                            .catch(error => console.error('Error:', error));
                    }
                });
            },

            resetForm() {
                this.form = {name: '', gender: 'Male', phone: '+855', email: '',password: '', croppedImage: null};
                this.imageFile = null;
                this.imagePreview = null;
                if (this.cropper) {
                    this.cropper.destroy();
                    this.cropper = null;
                }
            }
        },
        mounted() {
            this.fetchUsers();
        }
    }).mount('#app');
</script>

{% include "admin/footer_admin.html" %}
</body>

</html>
